<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Scoring on-chain</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root { 
            --accent: #00f2ff; 
            --bg: #030308; 
            --card: #0d0d1a; 
            --text-main: #ffffff;
            --text-dim: #a0a0b8;
            --success: #00ff88;
            --error: #ff0055;
        }
        
        body { 
            background: var(--bg); 
            color: var(--text-main); 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
            background-image: radial-gradient(circle at 50% 50%, #1a1a3a 0%, #030308 100%);
        }

        .container { 
            background: var(--card); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 28px; 
            padding: 40px; 
            width: 100%; 
            max-width: 420px; 
            text-align: center; 
            box-shadow: 0 40px 100px rgba(0,0,0,0.8); 
            backdrop-filter: blur(10px);
        }

        h1 { 
            font-size: 26px; 
            font-weight: 800;
            margin-bottom: 25px; 
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .range-container { margin: 20px 0; text-align: left; }
        .range-label { display: flex; justify-content: space-between; color: var(--text-dim); font-size: 13px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .amount-display { font-size: 28px; font-weight: 800; color: var(--accent); text-align: center; margin-bottom: 12px; }

        input[type=range] { width: 100%; -webkit-appearance: none; background: rgba(255,255,255,0.1); height: 6px; border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--accent); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px var(--accent); }

        .calculation-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px dashed rgba(0, 242, 255, 0.3);
            border-radius: 20px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .calc-title { font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 5px; }
        .calc-value { font-size: 24px; font-weight: 800; color: var(--success); }

        .btn { 
            background: var(--accent); 
            color: #000; 
            border: none; 
            padding: 18px 30px; 
            border-radius: 16px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            width: 100%; 
            font-size: 16px; 
            margin-top: 10px;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 242, 255, 0.3); }
        .btn:disabled { background: #333 !important; color: #666 !important; cursor: not-allowed; transform: none !important; }

        .btn-nft {
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 12px;
            margin-top: 10px;
            font-size: 12px;
            border-radius: 10px;
        }

        .dashboard { margin-top: 10px; padding: 20px; border-radius: 20px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); }
        .status-msg { font-size: 13px; margin-top: 20px; min-height: 20px; }

        .result-card {
            display: none;
            margin-top: 20px;
            padding: 25px;
            border-radius: 20px;
            font-weight: bold;
            animation: fadeIn 0.5s ease;
            line-height: 1.5;
            text-align: left;
        }

        .loader { 
            border: 3px solid rgba(255,255,255,0.1); 
            border-top: 3px solid var(--accent); 
            border-radius: 50%; 
            width: 20px; height: 20px; 
            animation: spin 1s linear infinite; 
            display: inline-block; 
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div style="font-size: 50px; margin-bottom: 15px;">üè¶</div>
    <h1>Credit Scoring on-chain</h1>

    <div id="authSection">
        <button id="connBtn" class="btn" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
    </div>
    
    <div id="dashboard" class="dashboard" style="display:none;">
        <div style="color: var(--text-dim); font-size: 11px; margin-bottom: 15px; text-align: center;">
            –ê–∫–∫–∞—É–Ω—Ç: <span id="userAddr" style="color: var(--accent);"></span>
        </div>

        <div class="range-container">
            <div class="range-label"><span>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞</span></div>
            <div class="amount-display" id="amountVal">$250</div>
            <input type="range" id="amountSlider" min="10" max="500" step="10" value="250" oninput="updateUI()">
        </div>

        <div class="range-container">
            <div class="range-label"><span>–°—Ä–æ–∫ (–º–µ—Å.)</span></div>
            <div class="amount-display" id="termVal" style="color: #fff; font-size: 22px;">4 –º–µ—Å—è—Ü–∞</div>
            <input type="range" id="termSlider" min="2" max="6" step="1" value="4" oninput="updateUI()">
        </div>

        <div class="calculation-box">
            <div class="calc-title">–ö –≤–æ–∑–≤—Ä–∞—Ç—É —á–µ—Ä–µ–∑ <span id="summaryTerm">4</span> –º–µ—Å. (+20%)</div>
            <div class="calc-value" id="totalToPay">$300.00</div>
        </div>

        <button id="actionBtn" class="btn" onclick="processCredit()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫—Ä–µ–¥–∏—Ç</button>
        <div style="font-size: 11px; color: #555; margin-top: 12px; text-align: center;">–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è: 0.001 BNB</div>
    </div>

    <div id="resultBox" class="result-card"></div>
    <div id="status" class="status-msg"></div>
</div>

<script>
    // --- –î–ê–ù–ù–´–ï –ö–û–ù–¢–†–ê–ö–¢–ê ---
    const CONTRACT_ADDRESS = "0xbb3f837De76e48374646d16c3522982fbB392Ca6"; 
    const BSC_API_KEY = "Y6U93JFUWVX6TBN37MB6NKVKWIPKEVAGEY"; 
    const INTEREST_RATE = 0.20; 

    // ABI –¥–ª—è —Å–≤—è–∑–∏ —Å —Ç–≤–æ–∏–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º Solidity
    const CONTRACT_ABI = [
        "function requestVerification() external payable",
        "function buyBoostNFT() external payable",
        "function hasPaidVerification(address) public view returns (bool)",
        "function isApproved(address) public view returns (bool)"
    ];

    let signer, address, contract;

    function updateUI() {
        const amount = parseFloat(document.getElementById('amountSlider').value);
        const term = document.getElementById('termSlider').value;
        document.getElementById('amountVal').innerText = "$" + amount;
        
        let suffix = " –º–µ—Å—è—Ü–∞";
        if (term == 5 || term == 6) suffix = " –º–µ—Å—è—Ü–µ–≤";
        document.getElementById('termVal').innerText = term + suffix;
        document.getElementById('summaryTerm').innerText = term;

        const total = amount + (amount * INTEREST_RATE);
        document.getElementById('totalToPay').innerText = "$" + total.toFixed(2);
    }

    async function connect() {
        if (window.ethereum) {
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                address = await signer.getAddress();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                document.getElementById('authSection').style.display = "none";
                document.getElementById('dashboard').style.display = "block";
                document.getElementById('userAddr').innerText = address.substring(0,6) + "..." + address.substring(38);
                updateUI();
                showStatus("–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω", "#00ff88");
            } catch (e) { showStatus("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞", "#ff0055"); }
        } else { alert("MetaMask –Ω–µ –Ω–∞–π–¥–µ–Ω!"); }
    }

    async function processCredit() {
        const btn = document.getElementById('actionBtn');
        btn.disabled = true;
        
        try {
            showStatus("<div class='loader'></div> –í—ã–∑–æ–≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ (0.001 BNB)...", "#fff");
            
            // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
            const tx = await contract.requestVerification({
                value: ethers.utils.parseEther("0.001")
            });
            
            showStatus("<div class='loader'></div> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —Å–µ—Ç–∏...", "#00f2ff");
            await tx.wait();

            showStatus("<div class='loader'></div> –ê–Ω–∞–ª–∏–∑ –±–ª–æ–∫—á–µ–π–Ω-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...", "#fff");
            await new Promise(r => setTimeout(r, 2000));
            
            const amount = document.getElementById('amountSlider').value;
            const term = document.getElementById('termSlider').value;
            await runAnalysis(amount, term);

        } catch (e) {
            console.error(e);
            showStatus("–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ –æ—Ç–º–µ–Ω–∞", "#ff0055");
            btn.disabled = false;
        }
    }

    async function buyNFT(price) {
        try {
            showStatus("<div class='loader'></div> –ü–æ–∫—É–ø–∫–∞ Boost NFT –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ...", "#fff");
            
            // –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫—É–ø–∫–∏ NFT –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ
            const tx = await contract.buyBoostNFT({
                value: ethers.utils.parseEther(price)
            });
            
            await tx.wait();
            showStatus("–†–µ–π—Ç–∏–Ω–≥ –ø–æ–≤—ã—à–µ–Ω!", "#00ff88");
            renderResult(true, "–ö–†–ï–î–ò–¢ –û–î–û–ë–†–ï–ù", "–í–∞—à NFT –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω. –°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.", false);
        } catch (e) {
            console.error(e);
            showStatus("–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏ NFT", "#ff0055");
        }
    }

    async function runAnalysis(reqAmount, reqTerm) {
        const url = `https://api.bscscan.com/api?module=account&action=txlist&address=${address}&sort=asc&apikey=${BSC_API_KEY}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            
            const resultBox = document.getElementById('resultBox');
            document.getElementById('dashboard').style.display = "none";
            resultBox.style.display = "block";
            document.getElementById('status').innerHTML = "";

            const totalRepayment = (parseFloat(reqAmount) * (1 + INTEREST_RATE)).toFixed(2);

            if (data.status === "0" || !data.result || data.result.length === 0) {
                renderResult(false, "–û–¢–ö–ê–ó–ê–ù–û", "–ö–æ—à–µ–ª–µ–∫ –ø—É—Å—Ç. –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.", true);
                return;
            }

            const txs = data.result;
            const firstTxTime = txs[0].timeStamp * 1000;
            const totalVol = txs.reduce((acc, tx) => acc + parseFloat(ethers.utils.formatEther(tx.value)), 0);
            
            const sixMonthsInMs = 180 * 24 * 60 * 60 * 1000; // –£–ø—Ä–æ—Å—Ç–∏–ª –¥–æ 6 –º–µ—Å –¥–ª—è —Ç–µ—Å—Ç–∞
            const isOldEnough = (Date.now() - firstTxTime) >= sixMonthsInMs;
            const isVolEnough = totalVol >= 0.5; // –°–Ω–∏–∑–∏–ª –ø–æ—Ä–æ–≥ –¥–ª—è —Ç–µ—Å—Ç–∞

            if (isOldEnough && isVolEnough) {
                renderResult(true, "–ö–†–ï–î–ò–¢ –û–î–û–ë–†–ï–ù", 
                `–°—É–º–º–∞ <b>$${reqAmount}</b> –æ–¥–æ–±—Ä–µ–Ω–∞.<br>` +
                `–ö –≤–æ–∑–≤—Ä–∞—Ç—É —á–µ—Ä–µ–∑ ${reqTerm} –º–µ—Å: <b style="color:#00ff88;">$${totalRepayment}</b>.<br><br>–û–∂–∏–¥–∞–π—Ç–µ –≤—ã–ø–ª–∞—Ç—É.`);
            } else {
                let reason = "–ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. ";
                if (!isOldEnough) reason += "–ö–æ—à–µ–ª–µ–∫ —Å–ª–∏—à–∫–æ–º –Ω–æ–≤—ã–π. ";
                if (!isVolEnough) reason += "–ú–∞–ª—ã–π –æ–±—ä–µ–º —Ç–æ—Ä–≥–æ–≤. ";
                
                renderResult(false, "–ù–£–ñ–ï–ù BOOST", reason + "<br><br>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ NFT –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞.", true);
            }
        } catch (e) { renderResult(false, "–û–®–ò–ë–ö–ê", "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ —Å–∫–æ—Ä–∏–Ω–≥.", false); }
    }

    function renderResult(isSuccess, title, text, showNFT) {
        const rb = document.getElementById('resultBox');
        rb.style.background = isSuccess ? "rgba(0, 255, 136, 0.1)" : "rgba(255, 0, 85, 0.1)";
        rb.style.color = isSuccess ? "#00ff88" : "#ff0055";
        rb.style.border = `1px solid ${isSuccess ? "#00ff88" : "#ff0055"}`;
        
        let content = `<div style="font-size:20px; margin-bottom:12px;">${isSuccess ? '‚úÖ' : '‚ùå'} ${title}</div>
                       <div style="font-size:14px; font-weight:normal; color:#e0e0e0; margin-bottom:15px;">${text}</div>`;
        
        if (showNFT) {
            content += `<button class="btn btn-nft" onclick="buyNFT('0.003')">–ö—É–ø–∏—Ç—å NFT Boost (0.003 BNB)</button>`;
            content += `<button class="btn btn-nft" onclick="buyNFT('0.007')">–ö—É–ø–∏—Ç—å Pro NFT (0.007 BNB)</button>`;
        }
        
        rb.innerHTML = content;
    }

    function showStatus(text, color) {
        const s = document.getElementById('status');
        s.innerHTML = text;
        s.style.color = color;
    }
</script>
</body>
</html>
